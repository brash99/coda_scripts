#!/bin/bash
#
# Bash script to start up Xterm Windows for ROCs and EBs
#
# Uncomment this to test outside of VNC adaq2:4
#VNCDESKTOP="coda"

TEST=0
ARGS=$@

# Default table
CODA_COMPONENT_TABLE=/adaqfs/home/adaq/Desktop/SBS_coda_scripts/shiftworker_table.cfg

if [ ${#@} -gt 0 ]; then
    # Get the CODA_COMPONENT_TABLE
    CODA_COMPONENT_TABLE=$1
fi

echo "Using CODA_COMPONENT_TABLE=${CODA_COMPONENT_TABLE}"

XTERM_EXE="xterm"
XTDIM=80x19
DEF_XINCR=510
DEF_YINCR=280
DEF_YSIZE=4

# These are the first displayed
FIRST_XPOS=0
FIRST_YPOS=30

# Hardcoded CODA_SCRIPTS and CODA_COMPONENT_TABLE
CODA_SCRIPTS=/adaqfs/home/sbs-onl/shiftworker_scripts/coda_scripts

. ${CODA_SCRIPTS}/coda_conf_functions
PATH=${CODA_SCRIPTS}:$PATH

. ${CODA_SCRIPTS}/coda_xterms_functions


starting_xterms_message

# Kill all previous Xterms remnants
if [ "$TEST" == "0" ]; then
    kXterms
fi


set_xterm_title_cmd() {
    local hostname=$1
    local component=$2
    local name=$3
    local option=

    codaconf_get_name_option $hostname $name
    option=$CODA_COMPONENT_OPTION

    XTERM_TITLE="$hostname : $component: $name"
    XTERM_CMD="remote_vme $hostname sbs-onl ${CODA_SCRIPTS}/start$component.sh $name $option"

    case "$component" in
	"ROC" )
	    XTERM_COLOR="lightgreen"
	    ;;
	"FPGA" )
	    XTERM_COLOR="lightgreen"
	    ;;
	"TS" )
	    XTERM_COLOR="yellow"
	    ;;
	"PEB" )
	    XTERM_COLOR="lightblue"
	    ;;
	"ER" )
	    XTERM_COLOR="tan"
	    ;;
	"SEB" )
	    XTERM_COLOR="orange"
	    ;;
	"DC" )
	    XTERM_COLOR="grey"
	    ;;
    esac

    if [ "$TEST" == "1" ]; then
	XTERM_CMD="read"
    fi
}

size=0
last_xpos=$FIRST_XPOS
last_ypos=$FIRST_YPOS
launch_xterm_group() {
    local type=$1
    local xpos=$2
    local xposincr=$3
    local ypos=$4
    local yposincr=$5
    local ysize=$6
    local ypos_orig=$ypos;

    coda_conf_get_component_list $type
    if [ $? == 1 ] ; then
	coda_hosts=${CODA_HOSTNAME_LIST[@]}
	for host in $coda_hosts
	do
	    if [ "$TEST" == "1" ]; then
		echo "x: $xpos  y: $ypos  size: $size"
	    fi

	    codaconf_get_component_name $host $type
	    set_xterm_title_cmd $host $type $CODA_COMPONENT_NAME
	    ${XTERM_EXE} -geometry $XTDIM+$xpos+$ypos -T "$XTERM_TITLE" -bg "$XTERM_COLOR" \
		  -e /bin/bash -c "$XTERM_CMD" &
	    size=$(echo "$size+1" | bc)
	    if [ "$size" == "$ysize" ]; then
		xpos=$(echo "$xpos+$xposincr" | bc)
		ypos=$FIRST_YPOS
		size=0
	    else
		ypos=$(echo "$ypos+$yposincr" | bc)
	    fi
	done

    fi

    last_xpos=$xpos
    last_ypos=$ypos
}

# Launch the FPGAs
launch_xterm_group FPGA $last_xpos ${DEF_XINCR} $last_ypos ${DEF_YINCR} ${DEF_YSIZE}

# Launch the ROCs
launch_xterm_group ROC $last_xpos  ${DEF_XINCR} $last_ypos ${DEF_YINCR} ${DEF_YSIZE}

# Launch the PEBs
launch_xterm_group PEB $last_xpos ${DEF_XINCR} $last_ypos ${DEF_YINCR} ${DEF_YSIZE}

# Launch the SEBs
launch_xterm_group SEB $last_xpos ${DEF_XINCR} $last_ypos ${DEF_YINCR} ${DEF_YSIZE}

# Launch the ERs
launch_xterm_group ER $last_xpos ${DEF_XINCR} $last_ypos ${DEF_YINCR} ${DEF_YSIZE}

# Launch the DCs
launch_xterm_group DC $last_xpos ${DEF_XINCR} $last_ypos ${DEF_YINCR} ${DEF_YSIZE}

# Launch the TSs
launch_xterm_group TS $last_xpos ${DEF_XINCR} $last_ypos ${DEF_YINCR} ${DEF_YSIZE}
